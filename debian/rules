#!/usr/bin/make -f

CC = $(DEB_HOST_GNU_TYPE)-gcc
CFLAGS := `dpkg-buildflags --get CFLAGS` -Wall
LDFLAGS := `dpkg-buildflags --get LDFLAGS`
CPPFLAGS := `dpkg-buildflags --get CPPFLAGS`

DEB_VERSION = $(shell dpkg-parsechangelog --show-field Version)
LSMCD_VERSION='1.4.38'
clean:
	rm -f lsmcd
	rm -rf debian/tmp

build: build-arch build-indep

binary: binary-arch binary-indep 
	
build-arch:
	wget https://github.com/litespeedtech/lsmcd/archive/refs/tags/v${LSMCD_VERSION}.tar.gz
	tar -zxf v${LSMCD_VERSION}.tar.gz
	cd lsmcd-*
	./fixtimestamp.sh
	./configure CFLAGS=" -O3" CXXFLAGS=" -O3"
	make

binary-arch:
	rm -rf debian/tmp
	mkdir -p debian/tmp/DEBIAN
	dpkg-gencontrol -plsmcd
	mkdir -p debian/tmp/usr/bin
	cp lsmcd debian/tmp/usr/bin
	strip --strip-unneeded --remove-section=.comment --remove-section=.note debian/tmp/usr/bin/lsmcd
	dpkg-deb --build debian/tmp ../lsmcd_$(DEB_VERSION)_$(DEB_TARGET_ARCH).deb

binary-indep:
	rm -rf debian/tmp
	mkdir -p debian/tmp/DEBIAN
	echo '<<<<<<dpkg-gencontrol>>>>>>'
	dpkg-gencontrol -plsmcd-doc
	mkdir -p debian/tmp/usr/share/man/man1
	echo '<<<<<<dpkg-deb --build debian/tmp>>>>>>'
	dpkg-deb --build debian/tmp ../lsmcd-doc_$(DEB_VERSION)_all.deb
